# ESPHome Cybex E-Priam BLE Bridge
# Kobler til barnevognen via Bluetooth og eksponerer kontroller til Home Assistant

substitutions:
  name: priam-bridge
  friendly_name: "Cybex E-Priam"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: arduino

# WiFi-konfigurasjon
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  ap:
    ssid: "${name}-fallback"
    password: "priam12345"

captive_portal:

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

# BLE Tracker for å finne Priam
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true

# BLE Client for å koble til Priam
ble_client:
  - mac_address: "XX:XX:XX:XX:XX:XX"  # Finn din Priam MAC-adresse
    id: priam_ble
    on_connect:
      then:
        - lambda: |-
            ESP_LOGI("priam", "Koblet til E-Priam!");
        - binary_sensor.template.publish:
            id: priam_connected
            state: ON
    on_disconnect:
      then:
        - lambda: |-
            ESP_LOGW("priam", "Frakoblet fra E-Priam");
        - binary_sensor.template.publish:
            id: priam_connected
            state: OFF

# Globale variabler for state
globals:
  - id: current_rocking_intensity
    type: int
    initial_value: '0'
  - id: current_drive_mode
    type: int
    initial_value: '1'

# Binær sensor for tilkoblingsstatus
binary_sensor:
  - platform: template
    name: "Tilkoblet"
    id: priam_connected
    device_class: connectivity

# Sensorer fra Priam
sensor:
  # Batteri fra status characteristic
  - platform: ble_client
    type: characteristic
    ble_client_id: priam_ble
    name: "Batteri"
    id: priam_battery
    service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
    characteristic_uuid: "a1fc0102-78d3-40c2-9b6f-3c5f7b2797df"
    notify: true
    unit_of_measurement: "%"
    device_class: battery
    accuracy_decimals: 0
    lambda: |-
      if (x.size() < 4) return NAN;
      int battery_volts = (x[3] & 255) * 2;
      int min_voltage = 315;
      int max_voltage = 380;
      float percentage = (float)(battery_volts - min_voltage) / (max_voltage - min_voltage) * 100.0;
      if (percentage > 100) percentage = 100;
      if (percentage < 0) percentage = 0;
      return percentage;

  # WiFi signal
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

# Tekst-sensorer for status
text_sensor:
  - platform: template
    name: "Kjøremodus"
    id: drive_mode_text
    lambda: |-
      switch(id(current_drive_mode)) {
        case 1: return {"ECO"};
        case 2: return {"TOUR"};
        case 3: return {"BOOST"};
        default: return {"Ukjent"};
      }

  - platform: template
    name: "Vugge-intensitet"
    id: rocking_text
    lambda: |-
      switch(id(current_rocking_intensity)) {
        case 0: return {"Av"};
        case 1: return {"Høy"};
        case 2: return {"Medium"};
        case 3: return {"Lav"};
        default: return {"Ukjent"};
      }

# Knapper for kontroll
button:
  # Vugge-kontroll
  - platform: template
    name: "Vugge: Av"
    icon: "mdi:sleep-off"
    on_press:
      - lambda: |-
          id(current_rocking_intensity) = 0;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0104-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x00, 0x37, 0x00]  # intensity=0, duration=55

  - platform: template
    name: "Vugge: Høy"
    icon: "mdi:vibrate"
    on_press:
      - lambda: |-
          id(current_rocking_intensity) = 1;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0104-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x01, 0x37, 0x00]  # intensity=1 (HIGH), duration=55

  - platform: template
    name: "Vugge: Medium"
    icon: "mdi:vibrate"
    on_press:
      - lambda: |-
          id(current_rocking_intensity) = 2;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0104-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x02, 0x37, 0x00]  # intensity=2 (MED), duration=55

  - platform: template
    name: "Vugge: Lav"
    icon: "mdi:vibrate"
    on_press:
      - lambda: |-
          id(current_rocking_intensity) = 3;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0104-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x03, 0x37, 0x00]  # intensity=3 (LOW), duration=55

  # Kjøremodus
  - platform: template
    name: "Modus: ECO"
    icon: "mdi:leaf"
    on_press:
      - lambda: |-
          id(current_drive_mode) = 1;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0103-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x01]

  - platform: template
    name: "Modus: TOUR"
    icon: "mdi:walk"
    on_press:
      - lambda: |-
          id(current_drive_mode) = 2;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0103-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x02]

  - platform: template
    name: "Modus: BOOST"
    icon: "mdi:rocket-launch"
    on_press:
      - lambda: |-
          id(current_drive_mode) = 3;
      - ble_client.ble_write:
          id: priam_ble
          service_uuid: "a1fc0100-78d3-40c2-9b6f-3c5f7b2797df"
          characteristic_uuid: "a1fc0103-78d3-40c2-9b6f-3c5f7b2797df"
          value: [0x03]

  # Restart-knapp
  - platform: restart
    name: "Restart ESP"
